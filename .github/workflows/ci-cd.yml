name: Build Lambda Package

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.13'
  AWS_REGION: 'ap-southeast-2'
  LAMBDA_RUNTIME: 'python3.13'
  LAMBDA_ARCHITECTURE: 'x86_64'

jobs:
  lint:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y gnupg2
        
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install black isort mypy
        
    - name: Format check with black
      run: |
        black --check lambda_pgp_decrypt_cryptography.py
        
    - name: Import sorting check with isort
      run: |
        isort --check-only lambda_pgp_decrypt_cryptography.py
        
    - name: Type check with mypy
      run: |
        mypy lambda_pgp_decrypt_cryptography.py --ignore-missing-imports

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Install security tools
      run: |
        python -m pip install --upgrade pip
        pip install bandit safety
        
    - name: Run Bandit security scan
      run: |
        bandit -r lambda_pgp_decrypt_cryptography.py -f json -o bandit-report.json || true
        
    - name: Run Safety check
      run: |
        safety check --json --output safety-report.json || true
        
    - name: Upload security reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-reports
        path: |
          bandit-report.json
          safety-report.json

  build:
    name: Build Lambda Package
    runs-on: ubuntu-latest
    needs: [lint, security]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y zip
        
    - name: Install Python dependencies (optimized)
      run: |
        python -m pip install --upgrade pip
        # Install only essential dependencies with no cache and minimal packages
        pip install --no-cache-dir --no-deps -r requirements.txt -t ./package
        # Install only the essential dependencies we actually use
        pip install --no-cache-dir boto3 botocore cryptography -t ./package
        
    - name: Create deployment package (optimized)
      run: |
        cp lambda_pgp_decrypt_cryptography.py ./package/
        cd package
        # Remove unnecessary files to reduce size
        find . -name "*.pyc" -delete
        find . -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true
        find . -name "*.dist-info" -type d -exec rm -rf {} + 2>/dev/null || true
        find . -name "tests" -type d -exec rm -rf {} + 2>/dev/null || true
        find . -name "*.egg-info" -type d -exec rm -rf {} + 2>/dev/null || true
        # Create optimized zip with compression
        zip -r -9 ../lambda-deployment-package.zip . -x "*.pyc" "__pycache__/*" "*/tests/*" "*.dist-info/*" "*.egg-info/*"
        
    - name: Check package size
      run: |
        cd ..
        PACKAGE_SIZE=$(du -h lambda-deployment-package.zip | cut -f1)
        PACKAGE_SIZE_MB=$(du -m lambda-deployment-package.zip | cut -f1)
        echo "ğŸ“¦ Package size: $PACKAGE_SIZE ($PACKAGE_SIZE_MB MB)"
        if [ $PACKAGE_SIZE_MB -gt 50 ]; then
          echo "âš ï¸  WARNING: Package size ($PACKAGE_SIZE_MB MB) exceeds 50MB limit"
          echo "ğŸ’¡ Consider using Lambda layers for large dependencies"
        else
          echo "âœ… Package size is within 50MB limit"
        fi
        
    - name: Create package info
      run: |
        echo "Package Information:" > package-info.txt
        echo "Runtime: ${{ env.LAMBDA_RUNTIME }}" >> package-info.txt
        echo "Architecture: ${{ env.LAMBDA_ARCHITECTURE }}" >> package-info.txt
        echo "Python Version: ${{ env.PYTHON_VERSION }}" >> package-info.txt
        echo "Build Date: $(date -u)" >> package-info.txt
        echo "Git Commit: ${{ github.sha }}" >> package-info.txt
        echo "Git Ref: ${{ github.ref }}" >> package-info.txt
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: lambda-deployment-package-${{ github.sha }}
        path: |
          lambda-deployment-package.zip
          package-info.txt
        retention-days: 30
        
    - name: Upload release artifact
      uses: actions/upload-artifact@v4
      if: github.ref == 'refs/heads/main'
      with:
        name: lambda-deployment-package-latest
        path: |
          lambda-deployment-package.zip
          package-info.txt
        retention-days: 90

  notify:
    name: Build Status Notification
    runs-on: ubuntu-latest
    needs: [lint, security, build]
    if: always()
    
    steps:
    - name: Notify on Success
      if: needs.build.result == 'success'
      run: |
        echo "âœ… Lambda package built successfully!"
        echo "ğŸ“¦ Package artifacts are available for download from GitHub Actions"
        echo "ğŸ”— Check the Actions tab to download the lambda-deployment-package.zip"
        
    - name: Notify on Failure
      if: needs.build.result == 'failure'
      run: |
        echo "âŒ Build failed!"
        exit 1